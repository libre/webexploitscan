#!/bin/bash
#
#    Program : build-rules.sh
#                  : New version 2017 - Add Autoupdate scanner. 
#                  : Build Rules folder and compile Webexploitscan. 
#  
#
#     Author : Saïd <libre@libre-cloud.org>
#                 : http://github.com/libre'
#
#     Parameters :  --help
#                 :         --version
#                 :
#    Licence : GPL
#      Notes : See --help for details
#======================================================================
# set -x
PROGNAME=`basename $0`
PROGPATH=`echo $0 | /bin/sed -e 's,[\\/][^\\/][^\\/]*$,,'`
BLIST="/tmp/tmp_buildrules.list"
if [ -z $BLIST ] ; then 
	rm -f $BLIST
fi
# Parsing all rules MD5 generator and catalogue in rules.list
cd ../../etc/webexploitscan
echo "Preparing building MD5 Check"
find rules.d/ -printf "%f\n" | sed 1d > $BLIST
cat $BLIST | while read filerule
do
	NewMD5=`md5sum rules.d/$filerule | awk '{ print $1 }'`
	NewURL="https://raw.githubusercontent.com/libre/webexploitscan/etc/webexploitscan/rules.d/$filerule"
	echo "$filerule;$NewURL;$NewMD5" >> rules.list_tmp
done
echo "Fix MD5 Check"
mv rules.list rules.list.old
mv rules.list_tmp rules.list
echo "Genereating MD5 For new List rules."
# MD5 Generator for rules.list to rules.md5
NewRulesMD5=`md5sum rules.list | awk '{ print $1 }'`
echo "New MD5 Rules list id is $NewRulesMD5"
echo "$NewRulesMD5" > rules.list.md5
# Check Version Rules file and incrémental Version ID
echo "New Version :"
CurrentVersion=`cat rules.list.version`
echo "Old version is : $CurrentVersion"
CurrentVersion=$((CurrentVersion+1))
echo "New version is : $CurrentVersion"
echo $CurrentVersion > rules.list.version
echo "Building is finish !"
rm -f $BLIST
echo "Build Binary Webexploitscan"
cd ../../usr/src
rm -f ../local/sbin/webexploitscan
shc -f webexploitscan.sh
mv -f webexploitscan.sh.x ../local/sbin/webexploitscan
echo ""
echo "Enjoy !"
exit 0






