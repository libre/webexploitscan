#!/bin/bash
#
#    Program : Webexploitscan Installer
#            :
#     Author : Saïd <libre@libre-cloud.org>
#            :    http://github.com/libre'
# Parameters : --help
#            :       --version
#            :
#            :
#    Licence : GPL
#      Notes : See --help for details
#======================================================================
#set -x
datelog=`date "+%F %H:%M:%S"`
print_usage(){
        echo "Usage: $PROGNAME [-(i)nstall | -(u)ninstall ]"
		echo "		-i  or -install	: Install"
		echo "		-u  or -uninstall	: uninstall (all)"
	echo ""
		echo "Usage: $PROGNAME --help -h"
}

print_help(){
        echo "$PROGNAME $REVISION"
        echo ""
        echo "webexploitscan detect backdoor..."
		echo "Installer for Debian and Ubuntu ALLVERSION"
        echo ""
        print_usage
        echo ""
        echo "webexploitscan. GPL  Said http://github.com/libre/webexploitscan 2017"
        echo ""
        exit 0
#        support
}

testsys(){
	# Vérification si Ubuntu Si non stop
	TESTDEBIAN=`cat /etc/*-release | grep -E "Debian|Ubuntu" | wc -l`
	if [ "$TESTDEBIAN" == "2" ]; then
		echo -e "[ $datelog ] [Info] Ubuntu Distro  detected ..."
		SYSD="d"
	elif [ "$TESTUBUNTU" == "2" ]; then
		echo -e "[ $datelog ] [Info] Ubuntu Distro  detected ..."
		SYSD="u"
	else
		SYSD="0"
	fi
	if [ "$SYSD" == "0" ]; then 
		echo -e "[ERROR] Not Ubuntu or Debian Distro detected ... Please check.."
		exit 1
	fi
	if [ "$TASK" == "INSTALL" ] ; then
		echo ""
		echo ""
		echo "¦¦+    ¦¦+¦¦¦¦¦¦¦+¦¦¦¦¦¦+ ¦¦¦¦¦¦¦+¦¦+  ¦¦+¦¦¦¦¦¦+ ¦¦+      ¦¦¦¦¦¦+ ¦¦+¦¦¦¦¦¦¦¦+¦¦¦¦¦¦¦+ ¦¦¦¦¦¦+ ¦¦¦¦¦+ ¦¦¦+   ¦¦+"
		echo "¦¦¦    ¦¦¦¦¦+----+¦¦+--¦¦+¦¦+----++¦¦+¦¦++¦¦+--¦¦+¦¦¦     ¦¦+---¦¦+¦¦¦+--¦¦+--+¦¦+----+¦¦+----+¦¦+--¦¦+¦¦¦¦+  ¦¦¦"
		echo "¦¦¦ ¦+ ¦¦¦¦¦¦¦¦+  ¦¦¦¦¦¦++¦¦¦¦¦+   +¦¦¦++ ¦¦¦¦¦¦++¦¦¦     ¦¦¦   ¦¦¦¦¦¦   ¦¦¦   ¦¦¦¦¦¦¦+¦¦¦     ¦¦¦¦¦¦¦¦¦¦+¦¦+ ¦¦¦"
		echo "¦¦¦¦¦¦+¦¦¦¦¦+--+  ¦¦+--¦¦+¦¦+--+   ¦¦+¦¦+ ¦¦+---+ ¦¦¦     ¦¦¦   ¦¦¦¦¦¦   ¦¦¦   +----¦¦¦¦¦¦     ¦¦+--¦¦¦¦¦¦+¦¦+¦¦¦"
		echo "+¦¦¦+¦¦¦++¦¦¦¦¦¦¦+¦¦¦¦¦¦++¦¦¦¦¦¦¦+¦¦++ ¦¦+¦¦¦     ¦¦¦¦¦¦¦++¦¦¦¦¦¦++¦¦¦   ¦¦¦   ¦¦¦¦¦¦¦¦+¦¦¦¦¦¦+¦¦¦  ¦¦¦¦¦¦ +¦¦¦¦¦"
		echo " +--++--+ +------++-----+ +------++-+  +-++-+     +------+ +-----+ +-+   +-+   +------+ +-----++-+  +-++-+  +---+"
		echo "                                                                                                                 "
		echo ""
		pinstall
	fi
	if [ "$TASK" == "UNINSTALL" ] ; then 
		unstall
	fi
	if [ "$TASK" == "" ] ; then
		print_help
	fi 	
}

pinstall(){

	if [ -e /usr/local/sbin/webexploitscan ]; then
		echo "webexploitscan is installed ... Please check or uninstall first."
		echo ""
		exit 1 
	else
		if [ -d usr/ ]; then 
			echo "Installing webexploitscan ..."
			cp -f usr/local/sbin/webexploitscan /usr/local/sbin/webexploitscan
			chmod +x /usr/local/sbin/webexploitscan
			mkdir /etc/webexploitscan
			mkdir /etc/webexploitscan/rules.d/
			mkdir /var/run/webexploitscan
			cp -f etc/webexploitscan/webexploitscan.conf /etc/webexploitscan/webexploitscan.conf
			cp -f etc/webexploitscan/white.list /etc/webexploitscan/white.list
			cp -f etc/webexploitscan/rules.list /etc/webexploitscan/rules.list
			cp -f etc/webexploitscan/rules.list.old /etc/webexploitscan/rules.list.old
			cp -f etc/webexploitscan/rules.list.version /etc/webexploitscan/rules.list.version
			cp -f etc/webexploitscan/rules.list.md5 /etc/webexploitscan/rules.list.md5
			cp -f etc/webexploitscan/rules.d/* /etc/webexploitscan/rules.d/
			chmod +x /usr/local/sbin/webexploitscan
			echo ""
			echo "Webexploitscan installed please look config and runit."
			echo "use : ~#webexploitscan -h for help"
			echo ""
			echo "Enjoy !"
			echo ""
			exit 0
	fi
fi	
}

unstall(){
	if [ ! -e /usr/local/sbin/webexploitscan ]; then
		echo "webexploitscan is not installed ..."
		echo ""
		exit 1 
	else
		echo "Uninstall webexploitscan ..."
		rm -f /usr/local/sbin/webexploitscan	
		rm -rf /etc/webexploitscan
		rm -rf /var/run/webexploitscan
		echo "webexploitscan is uninstalled !"
		echo ""
	fi
}

while test -n "$1"; do
	case "$1" in
		--help)
			print_help
			exit 0
			;;
		-h)
			print_help
			exit 0
			;;
		-install)
			TASK="INSTALL";
			shift;
			;;
		-i)
			TASK="INSTALL";
			shift;
			;;
		-uninstall)
			TASK="UNINSTALL";
			shift;
			;;
		-u)
			TASK="UNINSTALL";
			shift;
			;;
		*)
			echo "Unknown argument: $1"
			print_usage
			exit 1
			;;
	esac
	shift
done

# Test is root 
if [ "$(id -u)" != "0" ]; then
	echo "This script must be run as root" 1>&2
	echo "Please use sudo or execute on root" 1>&2
	exit 1
fi

testsys
