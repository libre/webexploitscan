#!/bin/bash
#
#    Program : antiwebxploitd Installer
#            :
#     Author : Saïd <libre@libre-cloud.org>
#            :    http://github.com/libre'
# Parameters : --help
#            :       --version
#            :
#            :
#    Licence : GPL
#      Notes : See --help for details
#======================================================================
#set -x
datelog=`date "+%F %H:%M:%S"`
print_usage(){
        echo "Usage: $PROGNAME [-(i)nstall | -(u)ninstall ]"
		echo "		-i  or -install	: Install"
		echo "		-u  or -uninstall	: uninstall (all)"
	echo ""
		echo "Usage: $PROGNAME --help -h"
        echo "Usage: $PROGNAME --version -v -V"
}
print_help(){
        echo "$PROGNAME $REVISION"
        echo ""
        echo "Realtime detect backdoor..."
		echo "Installer for Debian and Ubuntu ALLVERSION"
        echo ""
        print_usage
        echo ""
        echo "Antiwebxploitd. GPL Deraoui Said 2016"
        echo ""
        exit 0
#        support
}
# If we have arguments, process them.
testsys(){
	# Vérification si Ubuntu Si non stop
	TESTDEBIAN=`cat /etc/*-release | grep -E "Debian|Ubuntu" | wc -l`
	if [ "$TESTDEBIAN" == "2" ]; then
		echo -e "[ $datelog ] [Info] Ubuntu Distro  detected ..."
		SYSD="d"
	elif [ "$TESTUBUNTU" == "2" ]; then
		echo -e "[ $datelog ] [Info] Ubuntu Distro  detected ..."
		SYSD="u"
	else
		SYSD="0"
	fi
	if [ "$SYSD" == "0" ]; then 
		echo -e "[ERROR] Not Ubuntu or Debian Distro detected ... Please check.."
		exit 1
	fi
	if [ "$TASK" == "INSTALL" ] ; then
		pinstall
	fi
	if [ "$TASK" == "UNINSTALL" ] ; then 
		unstall
	fi
	if [ "$TASK" == "" ] ; then
		print_help
	fi 	
}

pinstall(){
	# Test existe dependance logiciel
	TESTINOTIFY=`find /usr/bin/  -name inotifywait | wc -l`
	if [ "$TESTINOTIFY" != "1" ]; then
		echo -e "inotifywait is not installed ... Please wait, installation bu APT."
		apt-get update; apt-get --yes --force-yes install inotify-tools
	fi
	TESTINOTIFY2=`find /usr/bin/  -name inotifywait | wc -l`
	if [ "$TESTINOTIFY2" != "1" ]; then
		echo -e "inotifywait is not installed ... Please wait, installation bu APT."
		echo -e "Humm, error. not installed dependance..."
		exit 1
	fi
	if [ -e /usr/local/sbin/antiwebxploitd ]; then
		echo "Antiwebxploitd is installed ... Please check or uninstall first."
		echo ""
		exit 1 
	else
		if [ -d usr/ ]; then 
			echo "Installing Antiwebxploitd ..."
			cp -f usr/local/sbin/antiwebxploitd /usr/local/sbin/antiwebxploitd
			cp -f usr/local/sbin/antiwebxploitscanner /usr/local/sbin/antiwebxploitscanner
			mkdir /etc/antiwebxploitd
			mkdir /etc/antiwebxploitd/rules.d
			mkdir /var/run/antiwebxploitd
			cp -f etc/antiwebxploitd/antiwebxploitd.conf /etc/antiwebxploitd/antiwebxploitd.conf
			cp -f etc/antiwebxploitd/white.list /etc/antiwebxploitd/white.list
			cp -f etc/init.d/antiwebxploitd /etc/init.d/antiwebxploitd
			cp -f etc/rules.d/* /etc/antiwebxploitd/rules.d
			chmod +x /etc/init.d/antiwebxploitd
			chmod +x /usr/local/sbin/antiwebxploitd
			chmod +x /usr/local/sbin/antiwebxploitscanner
			echo "STOP" > "/var/run/antiwebxploitd/antiwebxploitd.sock"
			echo ""
			echo "Antiwebxploitd installed please look config and runit."
			echo "So, is not automatic starting ... Please run update-rc.d for add deamon start on boot."
			echo ""
			echo "Enjoy !"
			echo ""
			echo "Command the deamon by init.d look help"
			exit 0
	fi
fi	
}

unstall(){
	if [ ! -e /usr/local/sbin/antiwebxploitd ]; then
		echo "Antiwebxploitd is not installed ..."
		echo ""
		exit 1 
	else
		echo "Uninstall Antiwebxploitd ..."
		rm -f /usr/local/sbin/antiwebxploitd
		rm -f /usr/local/sbin/antiwebxploitscanner		
		rm -f /etc/antiwebxploitd/antiwebxploitd.conf
		rm -f /etc/antiwebxploitd/rules.conf
		rm -f /etc/init.d/antiwebxploitd
		rm -f /var/run/antiwebxploitd/antiwebxploitd.sock 
		rm -f etc/antiwebxploitd/white.list /etc/antiwebxploitd/white.list
		rm -f  etc/rules.d/* /etc/antiwebxploitd/rules.d		
		rmdir --ignore-fail-on-non-empty /etc/antiwebxploitd
		rmdir --ignore-fail-on-non-empty /var/run/antiwebxploitd
		rmdir --ignore-fail-on-non-empty /etc/antiwebxploitd/rules.dd
		echo "Antiwebxploitd is uninstalled !"
		echo ""
	fi
}

while test -n "$1"; do
	case "$1" in
		--help)
			print_help
			exit 0
			;;
		-h)
			print_help
			exit 0
			;;
		-install)
			TASK="INSTALL";
			shift;
			;;
		-i)
			TASK="INSTALL";
			shift;
			;;
		-uninstall)
			TASK="UNINSTALL";
			shift;
			;;
		-u)
			TASK="UNINSTALL";
			shift;
			;;
		*)
			echo "Unknown argument: $1"
			print_usage
			exit 1
			;;
	esac
	shift
done

# Test is root 
if [ "$(id -u)" != "0" ]; then
	echo "This script must be run as root" 1>&2
	echo "Please use sudo or execute on root" 1>&2
	exit 1
fi

testsys
